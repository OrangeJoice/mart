<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monkey Mart - Private Edition</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        iframe { width: 100vw; height: 100vh; border: none; }
        #status { position: fixed; bottom: 10px; right: 10px; color: #555; font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <!-- This fetches the isolated game engine directly -->
    <iframe id="game" src="https://game-cdn.poki.com"></iframe>
    <div id="status">Checking for updates...</div>

    <script>
        // 1. Create the Service Worker code as a string
        const swCode = `
            const CACHE_NAME = 'monkey-mart-v1.6.16';
            const APP_ASSETS = ['/'];

            self.addEventListener('install', (e) => {
                self.skipWaiting();
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then((cachedResponse) => {
                        const networkFetch = fetch(event.request).then((networkResponse) => {
                            // Only cache successful responses from the game engine
                            if (networkResponse.ok) {
                                caches.open(CACHE_NAME).then((cache) => {
                                    cache.put(event.request, networkResponse.clone());
                                });
                            }
                            return networkResponse;
                        });
                        // Return cached version first (instant load), update in background
                        return cachedResponse || networkFetch;
                    })
                );
            });
        `;

        // 2. Turn that string into a "Virtual File" and register it
        if ('serviceWorker' in navigator) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(() => {
                document.getElementById('status').innerText = "Offline Ready / Updated";
            }).catch(err => {
                document.getElementById('status').innerText = "Update Check Failed";
            });
        }

        // 3. Keep Progress Safe
        // Your progress is automatically saved to LocalStorage by the game engine.
        // As long as you use this same URL, your coins and marts will stay.
    </script>
</body>
</html>
